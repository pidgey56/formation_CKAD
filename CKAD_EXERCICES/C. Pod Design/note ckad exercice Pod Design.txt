CKAD _ exercice:
    Pod Design:

        1: 
            Create 3 pods with names nginx1, nginx2, nginx3. All of them should have the label app=v1
                Action:
                    k run nginx1 --image=nginx --labels=app=v1 --dry-run=client -o yaml > 01_1.yaml
                    Copier le fichier 01_1.yaml en 01_2.yaml & 01_3.yaml
                    Editer les fichiers 01_2.yaml & 01_3.yaml pour changer le nom du pod et du container
                    for i in 1 2 3; do kubectl apply -f 01_$i.yaml; done                
                Question:
                    Est-ce qu'il y a la possibilité de variabiliser le contenue du fichier yaml lors de la génération avec kubectl run ?

        2:
            Show all labels of the pods
                Action:
                    for i in 1 2 3; do k describe pod nginx$i | grep -A2 Labels; done
                Remarque: 
                    Il est également possible d'avoir cette informations de manière plus propre
                    Voici un extrait du k get pod -h : Accepts a comma separated list of labels that are going to be presented as columns. Names are case-sensitive. You can also use multiple flag options like -L label1 -L label2...
                    --show-labels=false:
                    When printing, show all labels as the last column (default hide labels column)

        3:
            Change the labels of pod 'nginx' to be app=v2
                Action: 
                    # Update pod 'foo' with the label 'unhealthy' and the value 'true'
                    kubectl label pods nginx2 app=v2 --overwrite
                Remarque: 
                    Pour modifier un label existant, il faut ajouter l'option --overwrite, sinon une erreur
                    est retournée: error: 'app' already has a value (v1), and --overwrite is false
                    Dans le cas ou le label n'existe pas, l'option --overwrite n'est pas nécessaire.
                    k label pods nginx2 test=true
                    pod/nginx2 labeled

                    Il est également possible de modifier le label via un k edit pod nginx2 qui ouvre alors vim et permet de modifier la configuration du pod.

        4: 
            Get the label 'app' for the pods (show a column with APP labels)
                Action:
                    kubectl get pods -L app
        
        5:
            Get only the 'app=v2' pods
                Action:
                    kubectl get pods -l app=v2
                Remarque:
                    Cette option n'affiche pas le label dans le résultat, pour cela il faut ajouter l'option -L app
        6:
            Get 'app=v2' pods and not 'tier=frontend' pods
                Action:
                    kubectl get pods -l app=v2,tier!=frontend -L app,tier
        
        7:  
            Add a new label 'tier=web' to all pods habing 'app=v2' or 'app=v1' labels
                Action:
                    k label pods -l 'app in (v1,v2)' tier=web
                Remarque: 
                    Il est obligatoire ici d'utilier "app in (v1,v2)" pour cibler les pods ayant l'un ou l'autre des labels.
                    L'utilisation de la virgule "app=v1,app=v2" n'est pas possible dans ce cas car elle signifie un ET logique et non un OU logique.
        8:
            Add an annotation 'owner: marketing' to all pods having 'app=v2' label
                Action:
                    k annotate pods -l app=v2 owner=marketing
        
        9:
            Remove the 'app' label from the pods we created before
                Action:
                    k label pods -all app-
                Remarque:
                    Pour supprimer un label il faut ajouter un tiret apres le label que l'on souhaite supprimer. 
                    C'est comme faire un - label existant

        10:
            Annotate pods nginx1, nginx2, nginx3 with "description='my description'" value
                Action:
                    for i in 1 2 3; do k annotate pod nginx$i description='my description' --overwrite; done

        11:
            Check the annotation for pod nginx1
                Action: 
                    k describe pod nginx1 | grep Annotations -A3
        12:
            Remove the annotation 'description' from these three pods
                Action:
                    for i in 1 2 3; do k annotate pod nginx$i description-; done
                Remarque:
                    Le champ Annotations dans le k describe pod nginx1 est désormais à <none>

        13: remove all pods created before
                Action:
                    k delete pod nginx1 nginx2 nginx3

        14: 
            Create a pod that will be deployed to a Node that has the label 'accelerator=nvidia-tesla-p100'
                Action:
                    minikube node add #création d'un nouveau node
                    k get node # pour avoir le nom du nouveau node
                    k label node minikube-m02 accelerator=nvidia-tesla-p100
                    k get node --show-labels | grep accelerator #vérification du label
                    k run pod-node --dry-run=client -o yaml --image=nginx > 13.yaml
                    Editer le fichier 13.yaml pour ajouter le nodeSelector
                    k apply -f 13.yaml
        15: 
            Taint a node with key tier and value frontend with the effect NoSchedule. Then, create a pod that totelates this taint. 
                Action: 
                    k taint nodes minikube tier=frontend:NoSchedule
                    #pour supprimer le taint 
                    k taint nodes minikube tier-
                    apiVersion: v1
                    creation d'un fichier 15.yaml avec le contenu suivant:
                        kind: Pod
                        metadata:
                        labels:
                            run: tainted-pod
                        name: tainted-pod
                        spec:
                        containers:
                        - image: nginx
                            name: tainted-pod
                            resources: {}
                        dnsPolicy: ClusterFirst
                        restartPolicy: Always
                        nodeSelector: 
                            kubernetes.io/hostname: minikube
                        tolerations:
                        - key: "tier"
                            operator: "Equal"
                            value: "frontend"
                            effect: "NoSchedule"
                        status: {}
                    k apply -f 15.yaml
        16:
            Create a deployment with image nginx:1.18.0, called nginx, having 2 replicas, defining port 80 as the port that this container exposes (don't create a service for this deployment)
                Action: 
                    k create deployment deploy1 --image=nginx:1.18.0 --replicas=2 --port=80 --dry-run=Client -o yaml > 16.yaml
                    cat 16.yaml
                        apiVersion: apps/v1
                        kind: Deployment
                        metadata:
                        labels:
                            app: deploy1
                        name: deploy1
                        spec:
                        replicas: 2
                        selector:
                            matchLabels:
                            app: deploy1
                        strategy: {}
                        template:
                            metadata:
                            labels:
                                app: deploy1
                            spec:
                            containers:
                            - image: nginx:1.18.0
                                name: nginx
                                ports:
                                - containerPort: 80
                                resources: {}
                        status: {}
                    k apply -f 16.yaml
            17:
                View the YAML of this deployment
                    Action:
                        k get deployment deploy1 -o yaml
            
            18:
                View the YAML of the replica set that was created by this deployment
                    Action:
                        k get rs -l app=deploy1 -o yaml
            19: 
                Get the YAML for one of the pods 
                    Action: 
                        k get pods deploy1-85bc45f967-bsqxw -o yaml
            20:
                Check how the deployment rollout is going
                    Action:
                        k rollout status deployment deploy1             

            21: 
                Update the nginx image to nginx:1.19.8
                    Action:
                        k set image deployment deploy1 nginx=nginx:1.19.8
                    Remarque: 
                        Après la mise à jour de l'image, on peut vérifier que le déploiement s'est bien passé avec la commande k rollout status deployment deploy1
                        On peut également vérifier l'historique des déploiements avec k rollout history deployment deploy1
                        Pour revenir à une version précédente, on peut utiliser k rollout undo deployment deploy1 --to-revision=1 (ou le numéro de révision souhaité)
                        On observe également la création d'un nouveau replicaset.
            22:
                Do an on-purpose update of the deployment with a wrong image ngninx:1.91
                    Action:
                        k set image deployment deploy1 nginx=ngninx:1.91
                    Remarque:
                        Après cette mise à jour volontairement erronée, on peut vérifier le statut du déploiement avec k rollout status deployment deploy1
                        On constate que le déploiement est bloqué car l'image n'existe pas.
                        On remarque également que les pods précédent ne sont pas supprimés tant que le nouveau déploiement n'est pas réussi.
            23:
                Verify that something's wrong with the rollout
                    Action: 
                        k rollout status deployment deploy1
                    Remarque:
                        Le message d'erreur indique "Waiting for deployment "deploy1" rollout to finish: 1 out of 2 new replicas have been updated..." qui signifie qu'un pod a été crééé mais n'a pas pu démarrer correctement.
            24:
                Return the deployment to the second revision (number2) and verify the image is nginx:1.19.8
                    Action:
                        k rollout undo deployment deploy1 --to-revision=2
                    Remarque:
                        Après cette commande, on peut vérifier que le déploiement est revenu à la version précédente avec k rollout status deployment deploy1
                        On peut également vérifier l'image des pods avec k get pods -o wide | grep deploy1
            25: 
                Check the details of the fourth revision (number 4)
                    Action:
                        k rollout history deployment deploy1 --revision=4
            
            26:
                Scale the deployment to 5 replicas
                    Action: 
                        k scale --current-replicas=2 --replicas=5 deployment deploy1

            27:
                Autoscale the deployment, pods between 5 and 10, targeting CPU utilisation at 80%
                    Action: 
                        k autoscale deploy deploy1 --min=5 --max=10 --cpu=80%
                        k get hpa deploy1
                    Remarque:
                        hpa signifie Horizontal Pod Autoscaler
            28:
                Pause the rollout of the deployment
                    Action:
                        k rollout pause deployment deploy1
            29:
                Update the image to nginx:1.19.1 and check that there's nothing going on, since we paused the rollout
                    Action:
                        k set image deployment deploy1 nginx=nginx:1.19.1
                        k rollout status deployment deploy1
            30:
                Resume the rollout and check that the update is applied
                    Action:
                        k rollout resume deployment deploy1
                        k rollout status deployment deploy1

            31:
                Delete the deployment and the Horizontal Pod Autoscaler you created
                    Action:
                        k delete deployment deploy1
                        k delete hpa deploy1
                    Remarque:
                        La suppression du déploiement entraîne également la suppression des pods associés.
                        Supprimer le déploiement avant de supprimer le HPA est une bonne pratique pour éviter les erreurs et la création de pods qui pourraient surcharger le cluster.
            32: 
                Implement canary deployment by running two instances of nginx marked as version=v1 and version=v2 so that the load is balanced at 75%-25% ratio
                    Action:
                        k create deploy my-app-v1 --dry-run=client -o yaml > canary-v1.yaml
                        k create deploy my-app-v2 --dry-run=client -o yaml > canary-v2.yaml
                        Editer les fichiers des déploiements pour avoir le nombre correct de réplicats
                        Ajouter un init conteneur dans chaque déploiement pour éditer le contenu du fichier index.html de nginx pour afficher la version de l'application appelé
                        k apply -f canary-v1.yaml
                        k apply -f canary-v2.yaml
                        k run -it --rm --restart=Never busybox --image=busybox -- /bin/sh -c 'while sleep 1; do wget -qO- my-app-svc; done'

                    Remarque: 
                        On se rend compte que le service dispatche les appels d'un pod a l'autre avec une plus haute probabilité pour le pod version1
                